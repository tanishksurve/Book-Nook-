<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #E2EFF7;
      --secondary-color: #2c3e50;
      --accent-color: #3498db;
      --text-color: #333;
      --light-gray: #f5f5f5;
      --white: #ffffff;
      --discount-color: #e74c3c;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--white);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .cart-header {
      background-color: var(--primary-color);
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .cart-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color) 0%, rgba(226,239,247,0.8) 50%, var(--primary-color) 100%);
      z-index: 0;
    }
    
    .cart-header h1 {
      font-size: 2rem;
      color: var(--secondary-color);
      text-align: center;
      flex-grow: 1;
      position: relative;
      z-index: 1;
      animation: fadeIn 0.8s ease-out;
    }
    
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: var(--secondary-color);
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
    }
    
    .back-button:hover {
      background-color: var(--accent-color);
      transform: translateX(-5px);
    }
    
    .cart-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      animation: slideUp 0.5s ease-out;
    }
    
    #cart-container {
      margin-bottom: 2rem;
      background-color: var(--white);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    #cart-container:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      animation: fadeIn 0.8s ease-out;
    }
    
    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background-color: var(--primary-color);
      font-weight: 600;
      color: var(--secondary-color);
    }
    
    tr:hover {
      background-color: rgba(226, 239, 247, 0.3);
    }
    
    .original-price {
      text-decoration: line-through;
      color: #999;
      font-size: 0.9rem;
    }
    
    .discounted-price {
      color: var(--discount-color);
      font-weight: bold;
    }
    
    button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    button i {
      font-size: 0.9rem;
    }
    
    .empty-cart {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    
    .empty-cart i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--accent-color);
    }
    
    .total-section {
      padding: 1.5rem;
      text-align: right;
      background-color: var(--light-gray);
      border-top: 1px solid #e0e0e0;
    }
    
    .total-section h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    
    .discount {
      color: var(--discount-color);
      animation: pulse 1s infinite alternate;
    }
    
    .coupon-section {
      background-color: var(--primary-color);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      animation: slideUp 0.6s ease-out;
    }
    
    .coupon-section h3 {
      margin-bottom: 1rem;
      color: var(--secondary-color);
    }
    
    .coupon-input {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .coupon-input input {
      flex-grow: 1;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .coupon-input input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .buy-coupon {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    .buy-coupon a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 500;
    }
    
    .buy-coupon a:hover {
      text-decoration: underline;
    }
    
    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .button-group button {
      flex: 1;
      min-width: 200px;
      padding: 1rem;
      font-size: 1rem;
    }
    
    .coupon-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #2ecc71;
      color: white;
      padding: 1rem;
      border-radius: 4px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .coupon-notification.show {
      transform: translateX(0);
    }
    
    .coupon-notification.error {
      background-color: #e74c3c;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
    
    @media (max-width: 768px) {
      .cart-header {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }
      
      .cart-header h1 {
        font-size: 1.5rem;
      }
      
      table {
        font-size: 0.9rem;
      }
      
      th, td {
        padding: 0.75rem 0.5rem;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .button-group button {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      table {
        display: block;
        overflow-x: auto;
      }
      
      .coupon-input {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="cart-header">
    <a href="index.html" class="back-button">
      <i class="fas fa-arrow-left"></i> Back to Home
    </a>
    <h1>Your Shopping Cart</h1>
    <div></div>
  </div>

  <div class="cart-container">
    <div id="cart-container"></div>

    <div class="coupon-section">
      <h3>Have a coupon code?</h3>
      <div class="coupon-input">
        <input type="text" id="coupon-code" placeholder="Enter coupon code">
        <button onclick="applyCoupon()">Apply</button>
      </div>
      <p class="buy-coupon">Don't have a coupon? <a href="/html/">Buy a coupon and get discounts!</a></p>
      <p>Previous customers: Use your coupon code from last purchase</p>
      <div id="coupon-message"></div>
    </div>

    <div class="button-group">
      <button onclick="generateInvoice()"><i class="fas fa-file-invoice"></i> Generate Invoice PDF</button>
      <a href="/html/checkout.html">
        <button><i class="fas fa-shopping-cart"></i> Proceed to Checkout</button>
      </a>
    </div>
  </div>

  <div id="coupon-notification" class="coupon-notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-message"></span>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Your existing JavaScript remains unchanged
    let cart = [];
    let userId = localStorage.getItem("guestUserId");

    if (!userId) {
      userId = "guest-" + Date.now();
      localStorage.setItem("guestUserId", userId);
    }

    async function loadCartFromServer() {
      try {
        const res = await fetch(`http://localhost:4000/cart/${userId}`);
        const data = await res.json();

        if (res.ok) {
          cart = data;
          localStorage.setItem("cart", JSON.stringify(cart));
        } else {
          cart = JSON.parse(localStorage.getItem("cart")) || [];
        }

        renderCart();
      } catch (err) {
        console.error("Load cart error:", err);
        cart = JSON.parse(localStorage.getItem("cart")) || [];
        renderCart();
      }
    }

    function renderCart() {
      const container = document.getElementById("cart-container");
      if (!container) return;

      if (cart.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <p>Your cart is empty.</p>
          </div>`;
        return;
      }

      let html = '<table><tr><th>Title</th><th>Author</th><th>Price</th><th>Qty</th><th>Total</th><th>Remove</th></tr>';
      let grandTotal = 0;
      let discountTotal = 0;

      cart.forEach((item, index) => {
        const originalTotal = item.price * item.quantity;
        const discountedTotal = item.discountedPrice ? (item.discountedPrice * item.quantity) : originalTotal;
        
        grandTotal += originalTotal;
        discountTotal += item.discountedPrice ? (originalTotal - discountedTotal) : 0;
        
        html += `<tr>
          <td>${item.title}</td>
          <td>${item.author}</td>
          <td>
            ${item.discountedPrice ? 
              `<span class="original-price">â‚¹${item.price}</span><br>
               <span class="discounted-price">â‚¹${item.discountedPrice.toFixed(2)}</span>` : 
              `â‚¹${item.price}`}
          </td>
          <td>${item.quantity}</td>
          <td>${item.discountedPrice ? 
              `<span class="original-price">â‚¹${originalTotal.toFixed(2)}</span><br>
               <span class="discounted-price">â‚¹${discountedTotal.toFixed(2)}</span>` : 
              `â‚¹${originalTotal.toFixed(2)}`}
          </td>
          <td><button onclick="removeFromCart(${index})"><i class="fas fa-trash-alt"></i></button></td>
        </tr>`;
      });

      html += `</table>`;
      
      if (discountTotal > 0) {
        html += `<div class="total-section">
          <h3>Subtotal: â‚¹${grandTotal.toFixed(2)}</h3>
          <h3 class="discount">Discount: -â‚¹${discountTotal.toFixed(2)}</h3>
          <h3>Total: â‚¹${(grandTotal - discountTotal).toFixed(2)}</h3>
        </div>`;
      } else {
        html += `<div class="total-section">
          <h3>Total: â‚¹${grandTotal.toFixed(2)}</h3>
        </div>`;
      }
      
      container.innerHTML = html;
    }

    function showNotification(message, isError = false) {
      const notification = document.getElementById('coupon-notification');
      const messageElement = document.getElementById('notification-message');
      
      messageElement.textContent = message;
      notification.className = isError ? 'coupon-notification error' : 'coupon-notification';
      notification.classList.add('show');
      
      // Update icon based on error status
      const icon = notification.querySelector('i');
      icon.className = isError ? 'fas fa-exclamation-circle' : 'fas fa-check-circle';
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function applyCoupon() {
      const couponCode = document.getElementById('coupon-code').value.trim();
      const validCoupons = {
        'WELCOME10': { discount: 0.1, message: 'ðŸŽ‰ 10% discount applied!' },
        'BOOKLOVER': { discount: 0.15, message: 'ðŸ“š 15% discount for book lovers!' },
        'READMORE': { discount: 0.2, message: 'âœ¨ 20% discount applied!' },
        'SUMMER25': { discount: 0.25, message: 'â˜€ï¸ Summer special 25% off!' }
      };

      if (!couponCode) {
        showNotification('Please enter a coupon code', true);
        return;
      }

      if (validCoupons[couponCode]) {
        const { discount, message } = validCoupons[couponCode];
        cart.forEach(item => {
          item.discountedPrice = item.price * (1 - discount);
        });
        
        showNotification(message);
        renderCart();
        
        // Save coupon code in localStorage
        localStorage.setItem('lastUsedCoupon', couponCode);
      } else {
        showNotification('Invalid coupon code. Try WELCOME10, BOOKLOVER, or READMORE', true);
      }
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }

    function generateInvoice() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Invoice Header
  doc.setFillColor(226, 239, 247); // #E2EFF7
  doc.rect(0, 0, 210, 40, 'F');
  doc.setFontSize(24);
  doc.setTextColor(44, 62, 80); // #2c3e50
  doc.setFont('helvetica', 'bold');
  doc.text("ðŸ“š BookNook", 15, 25);
  doc.setFontSize(14);
  doc.text("Invoice", 180, 25, null, null, 'right');
  
  // Invoice Details
  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  doc.text(`Invoice #: ${Math.floor(100000 + Math.random() * 900000)}`, 15, 45);
  doc.text(`Date: ${new Date().toLocaleDateString()}`, 15, 50);
  
  // Customer Info
  doc.setFontSize(12);
  doc.setTextColor(44, 62, 80);
  doc.text("Bill To:", 15, 65);
  doc.setFont('helvetica', 'normal');
  doc.text("Guest Customer", 15, 70);
  doc.text(localStorage.getItem("guestUserId") || "Guest", 15, 75);
  
  // Line separator
  doc.setDrawColor(226, 239, 247);
  doc.setLineWidth(0.5);
  doc.line(15, 85, 195, 85);
  
  // Table Header
  doc.setFillColor(44, 62, 80); // #2c3e50
  doc.rect(15, 90, 180, 10, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(12);
  doc.text("No.", 20, 96);
  doc.text("Item", 30, 96);
  doc.text("Author", 100, 96);
  doc.text("Price", 140, 96);
  doc.text("Qty", 160, 96);
  doc.text("Total", 180, 96);
  
  // Table Rows
  let y = 105;
  doc.setTextColor(0, 0, 0);
  doc.setFont('helvetica', 'normal');
  
  cart.forEach((item, i) => {
    const price = item.discountedPrice || item.price;
    const total = price * item.quantity;
    
    // Alternate row colors
    if(i % 2 === 0) {
      doc.setFillColor(245, 245, 245);
      doc.rect(15, y-5, 180, 10, 'F');
    }
    
    doc.text(`${i+1}`, 20, y);
    doc.text(item.title.substring(0, 30), 30, y); // Limit title length
    doc.text(item.author.substring(0, 20), 100, y); // Limit author length
    doc.text(`â‚¹${price.toFixed(2)}`, 140, y);
    doc.text(`${item.quantity}`, 160, y);
    doc.text(`â‚¹${total.toFixed(2)}`, 180, y);
    y += 7;
  });
  
  // Summary
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const discount = cart.reduce((sum, item) => sum + (item.discountedPrice ? (item.price - item.discountedPrice) * item.quantity : 0), 0);
  const grandTotal = subtotal - discount;
  
  y += 10;
  doc.setFont('helvetica', 'bold');
  doc.text("Subtotal:", 150, y);
  doc.text(`â‚¹${subtotal.toFixed(2)}`, 180, y, null, null, 'right');
  y += 7;
  
  if(discount > 0) {
    doc.setTextColor(231, 76, 60); // #e74c3c
    doc.text("Discount:", 150, y);
    doc.text(`-â‚¹${discount.toFixed(2)}`, 180, y, null, null, 'right');
    y += 7;
    doc.setTextColor(0, 0, 0);
  }
  
  doc.setFontSize(14);
  doc.text("Total:", 150, y);
  doc.text(`â‚¹${grandTotal.toFixed(2)}`, 180, y, null, null, 'right');
  
  // Footer
  y += 20;
  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  doc.text("Thank you for shopping with BookNook!", 105, y, null, null, 'center');
  doc.text("Visit us again at www.booknook.com", 105, y+5, null, null, 'center');
  
  // Save the PDF
  doc.save(`BookNook_Invoice_${new Date().toISOString().slice(0,10)}.pdf`);
}

    async function syncCartToServer() {
      try {
        const res = await fetch("http://localhost:4000/cart/save", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ 
            cart, 
            userId: localStorage.getItem("guestUserId") 
          }),
        });

        const data = await res.json();
        if (res.ok) {
          showNotification("âœ… Cart saved to server!");
        } else {
          showNotification(data.error || "âŒ Failed to save cart.", true);
        }
      } catch (err) {
        console.error("Sync error:", err);
        showNotification("âŒ Sync failed. Check console for details", true);
      }
    }

    // Load last used coupon if exists
    window.addEventListener('DOMContentLoaded', () => {
      const lastCoupon = localStorage.getItem('lastUsedCoupon');
      if (lastCoupon) {
        document.getElementById('coupon-code').value = lastCoupon;
      }
    });

    window.onload = loadCartFromServer;
  </script>
</body>
</html>